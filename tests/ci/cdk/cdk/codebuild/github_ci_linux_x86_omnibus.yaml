# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0 OR ISC

version: 0.2

# Doc for batch https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-list
batch:
  build-matrix:
    static:
      env:
        type: LINUX_CONTAINER
        privileged-mode: false
        compute-type: BUILD_GENERAL1_SMALL
        variables:
          AWS_LC_CI_DEPENDENCIES: "cmake"
          GOPROXY: https://proxy.golang.org,direct
          GOROOT: /usr/local/go
          PATH: "$GOROOT/bin:$PATH"
    dynamic:
      env:
        variables:
          AWS_LC_CI_TARGET:
            - "tests/ci/run_posix_tests.sh"
            - "tests/ci/run_fips_tests.sh"
        image:
          - public.ecr.aws/docker/library/gcc:8
          - public.ecr.aws/docker/library/gcc:9
          - public.ecr.aws/docker/library/gcc:10
          - public.ecr.aws/docker/library/gcc:11
          - public.ecr.aws/docker/library/gcc:12
          - public.ecr.aws/docker/library/gcc:13

phases:
  install:
    commands:
      - apt update && apt install "${AWS_LC_CI_DEPENDENCIES}" -y
      - ./tests/ci/docker_images/dependencies/install_common_dependencies.sh
  build:
    commands:
      - "./${AWS_LC_CI_TARGET}"
