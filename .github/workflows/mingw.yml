name: MinGW
on:
  pull_request:
    branches: [ '*' ]
  push:
    branches: [ '*' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true
jobs:
  mingw:
    if: github.repository == 'aws/aws-lc'
    runs-on: windows-latest
    steps:
      - name: Install NASM
        uses: ilammy/setup-nasm@v1.5.1
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup MinGW
        uses: egor-tensin/setup-mingw@v2.2.0
        id: setup_mingw
        with:
          static: 0
      - name: Setup CMake
        uses: threeal/cmake-action@v1.3.0
        with:
          generator: Ninja
          c-compiler: ${{ steps.setup_mingw.outputs.gcc }}
          cxx-compiler: ${{ steps.setup_mingw.outputs.gxx }}
          options: |
            CMAKE_SYSTEM_NAME=Windows \
            CMAKE_SYSTEM_PROCESSOR=x86_64 \
            CMAKE_BUILD_TOOL=C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/ninja.exe \
            CMAKE_FIND_ROOT_PATH=C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64 \
            CMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            CMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            CMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
      - name: Build Project
        run: cmake --build ./build --target all
      - name: Run crypto_test
        run: ./build/crypto/crypto_test --gtest_also_run_disabled_tests
      - name: Run urandom_test
        run: ./build/crypto/urandom_test
      - name: Run mem_test
        run: ./build/crypto/mem_test
      - name: Run mem_set_test
        run: ./build/crypto/mem_set_test
      - name: Run dynamic_loading_test
        run: ./build/crypto/dynamic_loading_test
      - name: Run ssl_test
        run: ./build/ssl/ssl_test
      - name: Run SSL integration_test
        run: ./build/ssl/integration_test
